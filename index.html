<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ­ æ…¢ååå¹½çµ Â· åƒè±†è±†å°æ¸¸æˆ</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #1f3e44 0%, #0c353b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Nunito', 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
        }

        .game-box {
            background: #2b5e68;
            padding: 25px 30px 30px 30px;
            border-radius: 75px 75px 55px 55px;
            box-shadow: 0 18px 0 #12444b, 0 30px 35px #00000055;
            border: 5px solid #fecd7a;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 35px;
            background: #103138;
            box-shadow: inset 0 0 0 5px #bc9b68, 0 14px 0 #062026;
            width: 560px;
            height: 560px;
            cursor: none;
        }

        .dashboard {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 18px 10px 5px 10px;
        }

        .scoreboard {
            background: #251f1a;
            padding: 5px 35px 5px 25px;
            border-radius: 50px;
            box-shadow: inset 0 4px 0 #604e38, 0 8px 0 #0c2b30;
            color: #ffeec9;
            font-weight: 800;
            font-size: 1.6rem;
            display: flex;
            gap: 35px;
        }

        .scoreboard div {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .scoreboard span {
            background: #4a3626;
            padding: 4px 25px;
            border-radius: 45px;
            font-size: 2rem;
            color: #ffe19b;
            box-shadow: inset 0 -3px 0 #9b784c;
            min-width: 70px;
            text-align: center;
        }

        .btn-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: #fcc96b;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            color: #2b2219;
            padding: 12px 30px;
            border-radius: 60px;
            box-shadow: 0 9px 0 #ad7129, 0 5px 15px #ffd893;
            transition: 0.07s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn:active {
            transform: translateY(7px);
            box-shadow: 0 3px 0 #ad7129, 0 8px 20px #ffc467;
        }

        .info-bar {
            color: #fef3da;
            text-align: center;
            margin-top: 18px;
            font-size: 1.25rem;
            background: #2e7785;
            padding: 8px 35px;
            border-radius: 60px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border: 3px solid #fec260;
            font-weight: 600;
            display: flex;
            gap: 35px;
        }

        .tag {
            background: #f6b83e;
            padding: 3px 20px;
            border-radius: 40px;
            color: #1e2f35;
            font-size: 1.6rem;
        }
    </style>
    <!-- åœ†æ¶¦å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-box">
        <canvas id="gameCanvas" width="560" height="560"></canvas>

        <div class="dashboard">
            <div class="scoreboard">
                <div>ğŸ¬ è±†è±† <span id="scoreDisplay">0</span></div>
                <div>â¤ï¸ ç”Ÿå‘½ <span id="livesDisplay">3</span></div>
            </div>
            <div class="btn-group">
                <button class="btn" id="restartBtn"><span>ğŸ”„</span> é‡å¼€</button>
            </div>
        </div>

        <div class="info-bar">
            <span class="tag">â¬†ï¸â¬‡ï¸â¬…ï¸â¡ï¸</span> æ…¢æ…¢ç§»åŠ¨
            <span class="tag">ğŸ‘» å‘†å‘†å¹½çµ</span> å¾ˆå®¹æ˜“èº²
            <span class="tag">ğŸ’ å…¨åƒå®Œ</span>
        </div>
    </div>

    <script>
        (function() {
            // ----- ç”»å¸ƒ 560x560ï¼Œæ ¼å­ 28x28 (20x20 ç½‘æ ¼) -----
            const CELL_SIZE = 28;
            const ROWS = 20;
            const COLS = 20;

            const WALL = 0;
            const DOT = 1;
            const EMPTY = 2;

            // ç»å…¸è¿·å®«ï¼ˆç¨å¾®å¢åŠ äº†å¼€é˜”åº¦ï¼Œä½†ä¿ç•™è¶£å‘³æ‹è§’ï¼‰
            const baseMap = [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0],
                [0,1,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,1,0],
                [0,1,0,1,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0],
                [0,1,0,1,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0],
                [0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,1,0],
                [0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0],
                [0,1,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0],
                [0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,1,0],
                [0,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,0,1,0],
                [0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,1,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0],
                [0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0],
                [0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0],
                [0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ];

            // ----- DOM å…ƒç´  -----
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreSpan = document.getElementById('scoreDisplay');
            const livesSpan = document.getElementById('livesDisplay');
            const restartBtn = document.getElementById('restartBtn');

            // ----- æ¸¸æˆçŠ¶æ€ -----
            let board = JSON.parse(JSON.stringify(baseMap));
            let dotsTotal = 0;
            let dotsEaten = 0;
            let score = 0;
            let lives = 3;
            let gameOver = false;
            let gameWin = false;

            // ç©å®¶èµ·å§‹ä½ç½® (å®‰å…¨åŒºå·¦ä¸‹)
            let pacman = { x: 1, y: 1, dir: 'RIGHT' };

            // å¹½çµåˆå§‹ä½ç½® (æ”¾åœ¨å³ä¸Šè§’ï¼Œç¦»ç©å®¶å¾ˆè¿œ)
            let ghosts = [
                { x: 17, y: 3, dir: 'LEFT', moveCooldown: 0 },   // å¹½çµ1 è‡ªå¸¦å†·å´
                { x: 15, y: 16, dir: 'UP', moveCooldown: 0 }      // å¹½çµ2 ä¹Ÿå¸¦å†·å´
            ];

            // æ–¹å‘ç¼“å†²
            let nextDir = 'RIGHT';
            let currentDir = 'RIGHT';

            // ç§»åŠ¨é—´éš” (åƒè±†äººç§»åŠ¨é€Ÿåº¦ä¸å˜ï¼Œå¹½çµç§»åŠ¨å˜æ…¢: éœ€è¦é¢å¤–è®¡æ•°å™¨)
            const PLAYER_MOVE_INTERVAL = 6;       // çº¦ 60å¸§ => 10æ¬¡/ç§’
            const GHOST_MOVE_INTERVAL = 12;        // å¹½çµç§»åŠ¨é¢‘ç‡åªæœ‰ç©å®¶çš„ä¸€åŠï¼ æ›´éš¾æŠ“åˆ°äºº
            let frameCounter = 0;

            // ç‰¹æ•ˆ
            let eatGlow = 0;

            // ----- ç»Ÿè®¡è±†å­æ€»æ•° -----
            (function countDots() {
                let total = 0;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (baseMap[r][c] === DOT) total++;
                    }
                }
                dotsTotal = total;
            })();

            // è¾…åŠ©ï¼šæ˜¯å¦å¯è¡Œèµ°ï¼ˆä¸æ˜¯å¢™ï¼‰
            function isWalkable(col, row) {
                return col >= 0 && col < COLS && row >= 0 && row < ROWS && board[row][col] !== WALL;
            }

            // é‡ç½®
            function resetGame() {
                board = JSON.parse(JSON.stringify(baseMap));
                dotsEaten = 0;
                score = 0;
                lives = 3;
                gameOver = false;
                gameWin = false;
                pacman = { x: 1, y: 1, dir: 'RIGHT' };
                ghosts = [
                    { x: 17, y: 3, dir: 'LEFT', moveCooldown: 0 },
                    { x: 15, y: 16, dir: 'UP', moveCooldown: 0 }
                ];
                nextDir = 'RIGHT';
                currentDir = 'RIGHT';
                frameCounter = 0;
                eatGlow = 0;
                updateUI();
            }

            // åƒè±†
            function eatDot() {
                const { x, y } = pacman;
                if (board[y][x] === DOT) {
                    board[y][x] = EMPTY;
                    dotsEaten++;
                    score += 10;
                    eatGlow = 10;   // é—ªäº®
                    if (dotsEaten >= dotsTotal) gameWin = true;
                }
            }

            // ----- å¹½çµç§»åŠ¨ç­–ç•¥ï¼šæ…¢ + çŠ¹è±« + å®¹æ˜“å¡ä½ -----
            function moveGhosts() {
                for (let g of ghosts) {
                    // æ¯ä¸ªå¹½çµç‹¬ç«‹å†·å´ï¼šåªæœ‰ç´¯è®¡åˆ° GHOST_MOVE_INTERVAL æ‰åŠ¨
                    // æˆ‘ä»¬ç”¨ ghostsMoveCounter ç»Ÿä¸€è®¡æ•°ï¼Œä½†æ¯ä¸ªå¹½çµé¢å¤–æ¦‚ç‡è·³è¿‡ç§»åŠ¨ï¼ˆè®©å®ƒä»¬æ›´å‘†ï¼‰
                    // å¢åŠ éšæœºå‘å‘†: 40% å‡ ç‡å°±ç®—åˆ°äº†ç§»åŠ¨å¸§ä¹Ÿä¸åŠ¨ï¼ˆå‚»ä¹ä¹çš„ï¼‰
                    if (Math.random() < 0.4) continue;  // å¹½çµçªç„¶æ„£ä½ï¼Œä»€ä¹ˆéƒ½ä¸åš

                    const dirs = [
                        { name: 'LEFT', dx: -1, dy: 0 },
                        { name: 'RIGHT', dx: 1, dy: 0 },
                        { name: 'UP', dx: 0, dy: -1 },
                        { name: 'DOWN', dx: 0, dy: 1 }
                    ];

                    // ä¸å†å•çº¯è¿½é€ç©å®¶ï¼Œæ··åˆéšæœºï¼šå¢åŠ éšæœºæƒé‡ï¼Œè®©å®ƒä»¬æ¼«æ— ç›®çš„
                    let possibleMoves = [];
                    for (let d of dirs) {
                        let newX = g.x + d.dx;
                        let newY = g.y + d.dy;
                        if (isWalkable(newX, newY)) {
                            possibleMoves.push(d);
                        }
                    }

                    if (possibleMoves.length === 0) continue;  // å¡åœ¨å¢™è§’

                    // ä¸»è¦éšæœº â€”â€” å¤§éƒ¨åˆ†æƒ…å†µéšæœºé€‰æ–¹å‘ï¼Œå¶å°”æœç©å®¶èµ°ï¼ˆä½†éå¸¸è½»å¾®ï¼‰
                    // æ·éª°å­: 80% çº¯éšæœºèµ°åŠ¨ (åƒæ— å¤´è‹è‡) , 20% ç¨å¾®å°è¯•é è¿‘ç©å®¶
                    let chosenDir;
                    if (Math.random() < 0.2) {  // 20% è¶‹å‘ç©å®¶ (ä½†è®¡ç®—ä¹Ÿå¾ˆç¬¨)
                        // è®¡ç®—ç¦»ç©å®¶æ›¼å“ˆé¡¿è·ç¦»æœ€è¿‘çš„æ–¹å‘
                        let bestDist = 9999;
                        for (let d of possibleMoves) {
                            let newX = g.x + d.dx;
                            let newY = g.y + d.dy;
                            let dist = Math.abs(pacman.x - newX) + Math.abs(pacman.y - newY);
                            if (dist < bestDist) {
                                bestDist = dist;
                                chosenDir = d;
                            }
                        }
                    } else {
                        // 80% å®Œå…¨éšæœºé€‰ä¸€ä¸ªå¯èµ°æ–¹å‘ (åŒ…æ‹¬å¯èƒ½å›å¤´)
                        chosenDir = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                    }

                    // æ‰§è¡Œç§»åŠ¨
                    if (chosenDir) {
                        g.x += chosenDir.dx;
                        g.y += chosenDir.dy;
                        g.dir = chosenDir.name;
                    }
                }
            }

            // ç©å®¶ç§»åŠ¨
            function movePacman() {
                let dx = 0, dy = 0;
                switch (currentDir) {
                    case 'LEFT': dx = -1; break;
                    case 'RIGHT': dx = 1; break;
                    case 'UP': dy = -1; break;
                    case 'DOWN': dy = 1; break;
                }
                let newX = pacman.x + dx;
                let newY = pacman.y + dy;
                if (isWalkable(newX, newY)) {
                    pacman.x = newX;
                    pacman.y = newY;
                    pacman.dir = currentDir;
                    eatDot();
                }
            }

            // å°è¯•åˆ‡æ¢æ–¹å‘ (è¾“å…¥ç¼“å†²)
            function trySwitchDirection() {
                if (!nextDir) return;
                let dx = 0, dy = 0;
                switch (nextDir) {
                    case 'LEFT': dx = -1; break;
                    case 'RIGHT': dx = 1; break;
                    case 'UP': dy = -1; break;
                    case 'DOWN': dy = 1; break;
                }
                let newX = pacman.x + dx;
                let newY = pacman.y + dy;
                if (isWalkable(newX, newY)) {
                    currentDir = nextDir;
                }
            }

            // ç¢°æ’æ£€æµ‹
            function checkCollision() {
                for (let g of ghosts) {
                    if (g.x === pacman.x && g.y === pacman.y) return true;
                }
                return false;
            }

            // å¤„ç†æ­»äº¡ (å‡å‘½é‡ç”Ÿ)
            function handleDeath() {
                lives--;
                if (lives <= 0) {
                    gameOver = true;
                } else {
                    // é‡ç”Ÿå›åˆ°èµ·ç‚¹ï¼Œå¹½çµå¤ä½ï¼Œä½†åœ°å›¾è±†å­ä¿ç•™
                    pacman.x = 1; pacman.y = 1;
                    currentDir = 'RIGHT'; nextDir = 'RIGHT';
                    ghosts = [
                        { x: 17, y: 3, dir: 'LEFT', moveCooldown: 0 },
                        { x: 15, y: 16, dir: 'UP', moveCooldown: 0 }
                    ];
                    // å¦‚æœåŸç‚¹æœ‰è±†, ç«‹åˆ»åƒæ‰
                    eatDot();
                }
            }

            // æ›´æ–°UI
            function updateUI() {
                scoreSpan.innerText = score;
                livesSpan.innerText = lives;
            }

            // ----- ä¸»æ›´æ–°ï¼š ç©å®¶ä¸å¹½çµç§»åŠ¨é¢‘ç‡åˆ†å¼€ -----
            function gameUpdate() {
                if (gameOver || gameWin) return;

                frameCounter++;

                // ç©å®¶ç§»åŠ¨ (æ¯6å¸§)
                if (frameCounter % PLAYER_MOVE_INTERVAL === 0) {
                    trySwitchDirection();
                    movePacman();

                    // æ¯æ¬¡ç©å®¶ç§»åŠ¨åæ£€æŸ¥ç¢°æ’ï¼ˆä½†å¹½çµå¯èƒ½è¿˜æ²¡åŠ¨ï¼Œä¿ç•™ä¸€å®šå®½å®¹ï¼‰
                    if (checkCollision()) {
                        handleDeath();
                    }
                }

                // å¹½çµç§»åŠ¨ (æ¯12å¸§ï¼Œå¹¶ä¸”å†…éƒ¨è¿˜æœ‰éšæœºå‘å‘†ï¼Œæ‰€ä»¥è¶…æ…¢)
                if (frameCounter % GHOST_MOVE_INTERVAL === 0) {
                    moveGhosts();

                    // å¹½çµç§»åŠ¨åå†æ£€æŸ¥ä¸€æ¬¡ç¢°æ’
                    if (checkCollision()) {
                        handleDeath();
                    }
                }

                // å‡å°‘é—ªå…‰
                if (eatGlow > 0) eatGlow--;
            }

            // ----- ç»˜åˆ¶ (ä¿æŒå¯çˆ±) -----
            function draw() {
                ctx.clearRect(0, 0, 560, 560);

                // åŠé€æ˜ç½‘æ ¼
                ctx.strokeStyle = '#457b89';
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                for (let i = 0; i <= COLS; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * CELL_SIZE, 0);
                    ctx.lineTo(i * CELL_SIZE, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= ROWS; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, i * CELL_SIZE);
                    ctx.lineTo(canvas.width, i * CELL_SIZE);
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;

                // å¢™å£ å’Œ è±†å­
                for (let row = 0; row < ROWS; row++) {
                    for (let col = 0; col < COLS; col++) {
                        const cell = board[row][col];
                        const x = col * CELL_SIZE;
                        const y = row * CELL_SIZE;

                        if (cell === WALL) {
                            const grad = ctx.createLinearGradient(x, y, x+20, y+20);
                            grad.addColorStop(0, '#699eaf');
                            grad.addColorStop(1, '#2b6777');
                            ctx.fillStyle = grad;
                            ctx.fillRect(x+2, y+2, CELL_SIZE-4, CELL_SIZE-4);
                            ctx.fillStyle = '#b2d3e0';
                            ctx.fillRect(x+5, y+5, CELL_SIZE-12, CELL_SIZE-12);
                        } else if (cell === DOT) {
                            ctx.shadowColor = '#fdcc7a';
                            ctx.shadowBlur = 12;
                            ctx.beginPath();
                            ctx.arc(x + CELL_SIZE/2, y + CELL_SIZE/2, 8, 0, 2*Math.PI);
                            ctx.fillStyle = '#ffe094';
                            ctx.fill();
                            ctx.shadowBlur = 4;
                            ctx.beginPath();
                            ctx.arc(x + CELL_SIZE/2-3, y + CELL_SIZE/2-3, 2.5, 0, 2*Math.PI);
                            ctx.fillStyle = '#fffef0';
                            ctx.fill();
                            ctx.shadowBlur = 0;
                        } else {
                            // å°ç‚¹ç‚¹è£…é¥°
                            if ((row+col) % 5 === 0) {
                                ctx.fillStyle = '#3f7683';
                                ctx.beginPath();
                                ctx.arc(x+14, y+14, 2, 0, 2*Math.PI);
                                ctx.fill();
                            }
                        }
                    }
                }

                // é—ªå…‰ç‰¹æ•ˆ
                if (eatGlow > 0) {
                    ctx.fillStyle = `rgba(255, 250, 180, ${eatGlow * 0.03})`;
                    ctx.fillRect(0, 0, 560, 560);
                }

                // ç”»å¹½çµï¼ˆå‘†å‘†çš„æ ·å­ï¼‰
                for (let g of ghosts) {
                    const x = g.x * CELL_SIZE;
                    const y = g.y * CELL_SIZE;
                    // å½±å­
                    ctx.fillStyle = '#38262b';
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath();
                    ctx.ellipse(x+16, y+24, 11, 5, 0, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.globalAlpha = 1;

                    ctx.fillStyle = '#f96385';
                    ctx.shadowColor = '#b0304a';
                    ctx.shadowBlur = 14;
                    ctx.beginPath();
                    ctx.arc(x + 14, y + 12, 12, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillRect(x+4, y+14, 20, 8);

                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x + 8, y + 8, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + 20, y + 8, 4, 0, 2*Math.PI);
                    ctx.fill();

                    ctx.fillStyle = '#2b2828';
                    ctx.beginPath();
                    ctx.arc(x + 7, y + 7, 2, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + 19, y + 7, 2, 0, 2*Math.PI);
                    ctx.fill();

                    // ç”»ä¸ªé—®å·è¡¨ç¤ºå®ƒä»¬å¾ˆå‘†
                    ctx.font = 'bold 14px "Nunito"';
                    ctx.fillStyle = '#ffd966';
                    ctx.fillText('?', x+5, y-2);
                }

                // åƒè±†äºº
                const px = pacman.x * CELL_SIZE;
                const py = pacman.y * CELL_SIZE;
                let startAngle, endAngle;
                const mouth = 0.25 * Math.PI * (0.7 + 0.3 * Math.sin(Date.now() * 0.02));
                switch (pacman.dir) {
                    case 'RIGHT': startAngle = mouth; endAngle = 2*Math.PI - mouth; break;
                    case 'LEFT': startAngle = Math.PI + mouth; endAngle = Math.PI - mouth; break;
                    case 'UP': startAngle = 1.5*Math.PI + mouth; endAngle = 1.5*Math.PI - mouth; break;
                    case 'DOWN': startAngle = 0.5*Math.PI + mouth; endAngle = 0.5*Math.PI - mouth; break;
                    default: startAngle=0.2; endAngle=1.8*Math.PI;
                }
                ctx.shadowColor = '#fcba48';
                ctx.shadowBlur = 20;
                ctx.fillStyle = '#fde074';
                ctx.beginPath();
                ctx.moveTo(px+14, py+14);
                ctx.arc(px+14, py+14, 13, startAngle, endAngle);
                ctx.closePath();
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#382f1f';
                ctx.beginPath();
                ctx.arc(px+18, py+8, 2.5, 0, 2*Math.PI);
                ctx.fill();

                // èƒœåˆ©/ç»“æŸ
                if (gameWin) {
                    ctx.fillStyle = '#9de0c0cc';
                    ctx.fillRect(0, 0, 560, 560);
                    ctx.font = 'bold 48px "Nunito", sans-serif';
                    ctx.fillStyle = '#fefbcd';
                    ctx.shadowColor = '#d49f47';
                    ctx.shadowBlur = 15;
                    ctx.fillText('ğŸ‰ ä½ èµ¢å•¦', 120, 300);
                } else if (gameOver) {
                    ctx.fillStyle = '#2c1422cc';
                    ctx.fillRect(0, 0, 560, 560);
                    ctx.font = 'bold 48px "Nunito"';
                    ctx.fillStyle = '#fcc6c6';
                    ctx.shadowColor = '#9f3e3e';
                    ctx.shadowBlur = 15;
                    ctx.fillText('ğŸ˜¶ æ²¡å‘½å•¦', 130, 300);
                }

                ctx.shadowBlur = 0;
            }

            // ----- åŠ¨ç”»å¾ªç¯ -----
            let animFrame;
            function loop() {
                gameUpdate();
                draw();
                updateUI();
                animFrame = requestAnimationFrame(loop);
            }

            // ----- é”®ç›˜äº‹ä»¶ -----
            function keydown(e) {
                if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                    const key = e.key;
                    if (key === 'ArrowLeft') nextDir = 'LEFT';
                    else if (key === 'ArrowRight') nextDir = 'RIGHT';
                    else if (key === 'ArrowUp') nextDir = 'UP';
                    else if (key === 'ArrowDown') nextDir = 'DOWN';
                }
            }
            window.addEventListener('keydown', keydown);

            // é‡å¯æŒ‰é’®
            restartBtn.addEventListener('click', () => {
                resetGame();
            });

            // åˆå§‹åŒ–
            resetGame();
            loop();

            // æ¸…ç†
            window.addEventListener('beforeunload', () => {
                if (animFrame) cancelAnimationFrame(animFrame);
                window.removeEventListener('keydown', keydown);
            });
        })();
    </script>
</body>
</html>