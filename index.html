<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ è±†è±†å¤§å†’é™© Â· è¶£å‘³åƒè±†è±†</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            background: linear-gradient(145deg, #1b262c 0%, #0f4c5c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .game-wrapper {
            background: #1e3d42;
            padding: 25px 30px 30px 30px;
            border-radius: 60px 60px 40px 40px;
            box-shadow: 0 20px 0 #0b2a2e, 0 30px 30px rgba(0,0,0,0.5);
            border: 4px solid #fbc490;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 30px;
            background: #0e2a2f;
            box-shadow: inset 0 0 0 4px #a9875a, 0 12px 0 #072025;
            cursor: none;
            width: 500px;
            height: 500px;
        }
        .panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 18px;
            padding: 0 8px;
        }
        .stats {
            background: #231f1b;
            padding: 8px 22px;
            border-radius: 60px;
            box-shadow: inset 0 3px 0 #5f4d3a, 0 6px 0 #0b1d20;
            color: #fae6c3;
            font-weight: bold;
            font-size: 1.4rem;
            letter-spacing: 1px;
            display: flex;
            gap: 30px;
        }
        .stats span {
            color: #ffcf9a;
            background: #3f3227;
            padding: 4px 16px;
            border-radius: 50px;
            margin-left: 8px;
            font-size: 1.6rem;
            box-shadow: inset 0 -2px 0 #876b4f;
        }
        .controls {
            display: flex;
            gap: 18px;
        }
        button {
            background: #facc6f;
            border: none;
            font-size: 1.8rem;
            font-weight: bold;
            color: #28231d;
            padding: 10px 28px;
            border-radius: 40px;
            box-shadow: 0 8px 0 #b2782a, 0 4px 15px rgba(255,215,100,0.5);
            transition: all 0.06s ease-out;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        button:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #b2782a, 0 6px 12px #ffb882;
        }
        .tip {
            color: #fae9d0;
            text-align: center;
            margin-top: 16px;
            font-size: 1.2rem;
            text-shadow: 3px 3px 0 #164247;
            background: #386f7a;
            padding: 8px 25px;
            border-radius: 40px;
            display: inline-block;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
            border: 2px solid #ffcf81;
            font-weight: 600;
        }
        .emoji-big {
            font-size: 2rem;
            filter: drop-shadow(2px 4px 0 #453f38);
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <canvas id="gameCanvas" width="500" height="500"></canvas>
        
        <div class="panel">
            <div class="stats">
                ğŸ¬è±†è±† <span id="scoreDisplay">0</span>
                ğŸ˜‹ğŸ˜‹ <span id="livesDisplay">3</span>
            </div>
            <div class="controls">
                <button id="restartBtn"><span class="emoji-big">ğŸ”„</span> é‡æ¥</button>
            </div>
        </div>
        <div class="tip">
            ğŸ•¹ï¸ æ–¹å‘é”®ç§»åŠ¨ Â· é¿å¼€çº¢è‰²å¹½çµ Â· åƒæ‰æ‰€æœ‰é‡‘è±†å°±èµ¢å•¦
        </div>
    </div>

    <script>
        (function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreSpan = document.getElementById('scoreDisplay');
            const livesSpan = document.getElementById('livesDisplay');
            const restartBtn = document.getElementById('restartBtn');

            // ---------- æ¸¸æˆé…ç½® ----------
            const CELL_SIZE = 25;           // 20x20 ç½‘æ ¼ (500/25=20)
            const ROWS = 20;
            const COLS = 20;

            // è¿·å®«å®šä¹‰ (0=å¢™, 1=è±†å­, 2=ç©ºåœ°, 3=å¤§ç³–æœ? ä½†ä¸ºäº†ç®€å•éƒ½ç”¨è±†å­)
            // æ‰‹å·¥è®¾è®¡ä¸€ä¸ªå‹å¥½è¿·å®«ï¼ŒåŒ…å«é€šè·¯å’Œè±†å­ï¼Œè±†è±†å‡ºç”Ÿåœ¨å·¦ä¸‹ï¼Œå¹½çµåœ¨å³ä¸Š
            const WALL = 0;
            const DOT = 1;       // æ™®é€šè±†
            const EMPTY = 2;      // ç©ºåœ°(æ²¡æœ‰è±†)

            // åˆå§‹åœ°å›¾ (è¶£å‘³æ€§è®¾è®¡ï¼Œæœ‰æ›²æŠ˜ï¼Œä½†å¾ˆå¼€é˜”)
            const baseMap = [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0],
                [0,1,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,1,0],
                [0,1,0,1,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0],
                [0,1,0,1,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0],
                [0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,1,0],
                [0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0],
                [0,1,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0],
                [0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,1,0],
                [0,1,1,1,1,1,0,1,1,0,1,1,0,1,1,0,1,0,1,0],
                [0,0,0,0,0,1,0,1,0,0,0,1,0,1,0,0,1,0,1,0],
                [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0],
                [0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0],
                [0,1,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0],
                [0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ];

            // ---------- æ¸¸æˆçŠ¶æ€ ----------
            let board = JSON.parse(JSON.stringify(baseMap));   // å½“å‰åœ°å›¾è±†å­æƒ…å†µ
            let dotsTotal = 0;          // æ€»è±†å­æ•°(ç”¨äºèƒœåˆ©)
            let dotsEaten = 0;
            let score = 0;              // å®é™…å¾—åˆ† (åƒä¸€ä¸ªè±†+10)
            let lives = 3;
            let gameOver = false;
            let gameWin = false;
            let animationFrame = null;

            // ç©å®¶ä½ç½® (æ ¼å­åæ ‡)
            let pacman = { x: 1, y: 1 };   // èµ·å§‹(1,1)æ˜¯è±†å­åŒºåŸŸ
            // å¹½çµä½ç½®
            let ghosts = [
                { x: 16, y: 10, dir: 'RIGHT' },   // å¹½çµ1
                { x: 10, y: 16, dir: 'UP' }       // å¹½çµ2 å¢åŠ ä¸€ç‚¹å˜åŒ–
            ];

            // æ–¹å‘æ§åˆ¶ (ç©å®¶)
            let nextDir = 'RIGHT';      // ä¸‹æ¬¡ç§»åŠ¨æ–¹å‘
            let currentDir = 'RIGHT';    // å½“å‰ç§»åŠ¨æ–¹å‘

            // ç§»åŠ¨å†·å´ (è®©ç§»åŠ¨ä¸è¦å¤ªå¿«ï¼Œä½†é€šè¿‡å¸§ç‡æ§åˆ¶)
            const MOVE_INTERVAL = 8;      // æ¯8å¸§ç§»åŠ¨ä¸€æ¬¡ (å¤§çº¦ 60å¸§ => 7-8æ¬¡/ç§’ï¼Œæ‰‹æ„Ÿå‹å¥½)
            let frameCounter = 0;

            // é¢„åˆå§‹åŒ–è®¡ç®—æ€»è±†å­æ•°
            function countDots() {
                let total = 0;
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (baseMap[r][c] === DOT) total++;
                    }
                }
                dotsTotal = total;
            }
            countDots();

            // é‡ç½®æ¸¸æˆ (ä¿ç•™åˆå§‹åœ°å›¾)
            function resetGame() {
                // å¤åˆ¶åˆå§‹åœ°å›¾
                board = JSON.parse(JSON.stringify(baseMap));
                dotsEaten = 0;
                score = 0;
                lives = 3;
                gameOver = false;
                gameWin = false;

                pacman = { x: 1, y: 1 };   // å·¦ä¸‹åŒºåŸŸ (1,1)
                ghosts = [
                    { x: 16, y: 10, dir: 'RIGHT' },
                    { x: 10, y: 16, dir: 'UP' }
                ];
                nextDir = 'RIGHT';
                currentDir = 'RIGHT';
                frameCounter = 0;
                updateScoreAndLives();
            }

            // è¾…åŠ©: è¾¹ç•Œ/å¢™å£æ£€æŸ¥ (æ ¼å­æ˜¯å¦å¯èµ°)
            function isWalkable(col, row) {
                // å¢™å£åˆ¤æ–­ï¼š0æ˜¯å¢™ï¼Œå…¶å®ƒéƒ½å¯èµ° (åŒ…æ‹¬è±†å­å’Œç©ºåœ°)
                return (col >= 0 && col < COLS && row >= 0 && row < ROWS && board[row][col] !== WALL);
            }

            // å¹½çµç§»åŠ¨ (ç®€å•è¿½é€: æ›¼å“ˆé¡¿è·ç¦»æœç€ç©å®¶ç§»åŠ¨ï¼Œä½†éšæœºæ…å±€å¢åŠ è¶£å‘³)
            function moveGhosts() {
                for (let g of ghosts) {
                    // å››ä¸ªæ–¹å‘: å·¦ å³ ä¸Š ä¸‹
                    const dirs = [
                        { name: 'LEFT',  dx: -1, dy: 0 },
                        { name: 'RIGHT', dx: 1,  dy: 0 },
                        { name: 'UP',    dx: 0,  dy: -1 },
                        { name: 'DOWN',  dx: 0,  dy: 1 }
                    ];

                    // è®¡ç®—åˆ°ç©å®¶çš„æ–¹å‘åå¥½ (å‡å»ç©å®¶ä½ç½®ï¼Œå–åä½¿å¾—å¹½çµæƒ³é è¿‘)
                    let dxPlayer = pacman.x - g.x;
                    let dyPlayer = pacman.y - g.y;

                    // ç»™æ¯ä¸ªæ–¹å‘æ‰“åˆ†: è¶Šèƒ½å‡å°‘ä¸ç©å®¶è·ç¦»åˆ†è¶Šé«˜ (åŒæ—¶ä¹Ÿéšæœºå¾®è°ƒï¼Œé¿å…å¤ªèªæ˜)
                    let bestScore = -Infinity;
                    let bestDirs = [];

                    for (let d of dirs) {
                        let newX = g.x + d.dx;
                        let newY = g.y + d.dy;
                        if (!isWalkable(newX, newY)) continue;   // å¢™å£è·³è¿‡

                        // è®¡ç®—ç§»åŠ¨åä¸ç©å®¶çš„è·ç¦»å˜åŒ– (æ›¼å“ˆé¡¿)
                        let newDist = Math.abs(pacman.x - newX) + Math.abs(pacman.y - newY);
                        let oldDist = Math.abs(pacman.x - g.x) + Math.abs(pacman.y - g.y);
                        // åˆ†æ•°è¶Šå°è¶Šå¥½ï¼Ÿè¿™é‡Œç”¨ -newDist ä½¿å¾—è¾ƒå°è·ç¦»å¾—é«˜åˆ†ï¼Œå†åŠ ä¸€ç‚¹éšæœºæŠ–åŠ¨(0~0.9)
                        let scoreVal = -newDist + (Math.random() * 0.8 - 0.4); 

                        if (scoreVal > bestScore) {
                            bestScore = scoreVal;
                            bestDirs = [d.name];
                        } else if (Math.abs(scoreVal - bestScore) < 0.01) {
                            bestDirs.push(d.name);
                        }
                    }

                    if (bestDirs.length === 0) continue; // æ— è·¯å¯èµ°? å¯èƒ½è¢«åŒ…å›´ï¼Œä¸åŠ¨

                    // éšæœºé€‰ä¸€ä¸ªæœ€ä½³æ–¹å‘ï¼ˆå¢åŠ ä¸å¯é¢„æµ‹æ€§ï¼‰
                    let chosenDir = bestDirs[Math.floor(Math.random() * bestDirs.length)];
                    let move = dirs.find(d => d.name === chosenDir);
                    if (move) {
                        g.x += move.dx;
                        g.y += move.dy;
                        g.dir = chosenDir;  // è®°å½•é¢å‘æ–¹å‘ï¼ˆç»˜å›¾ç”¨ï¼‰
                    } else {
                        // ä¿åº•ï¼šéšä¾¿é€‰ä¸€ä¸ªå¯è¡Œæ–¹å‘
                        for (let d of dirs) {
                            if (isWalkable(g.x + d.dx, g.y + d.dy)) {
                                g.x += d.dx;
                                g.y += d.dy;
                                g.dir = d.name;
                                break;
                            }
                        }
                    }
                }
            }

            // åƒè±†é€»è¾‘: è‹¥ç©å®¶æ‰€åœ¨æ ¼æœ‰è±†å­ï¼Œåƒæ‰å¹¶åŠ åˆ†
            function eatDotAtPacman() {
                const { x, y } = pacman;
                if (board[y][x] === DOT) {
                    board[y][x] = EMPTY;
                    dotsEaten++;
                    score += 10;
                    // èƒœåˆ©æ¡ä»¶: æ‰€æœ‰è±†å­è¢«åƒå®Œ
                    if (dotsEaten >= dotsTotal) {
                        gameWin = true;
                    }
                }
            }

            // æ£€æŸ¥ç©å®¶ä¸å¹½çµç¢°æ’
            function checkGhostCollision() {
                for (let g of ghosts) {
                    if (g.x === pacman.x && g.y === pacman.y) {
                        return true;
                    }
                }
                return false;
            }

            // å¤„ç†ç©å®¶æ­»äº¡/å‡å‘½
            function handleDeath() {
                lives--;
                if (lives <= 0) {
                    gameOver = true;
                } else {
                    // é‡ç”Ÿ: å›åˆ°èµ·ç‚¹ï¼Œé‡ç½®è±†å­ï¼Ÿ ä¸ºäº†å‹å¥½, è±†å­ä¿æŒè¢«åƒçŠ¶æ€, å¹½çµé‡ç½®ä½ç½®ä½†åœ°å›¾è±†å­ä¸å˜
                    pacman.x = 1;
                    pacman.y = 1;
                    currentDir = 'RIGHT';
                    nextDir = 'RIGHT';
                    ghosts = [
                        { x: 16, y: 10, dir: 'RIGHT' },
                        { x: 10, y: 16, dir: 'UP' }
                    ];
                    // ä½†æ³¨æ„ï¼Œå¦‚æœé‡ç”Ÿæ—¶è±†å­è¿˜åœ¨åŸç‚¹ï¼Œå¯ä»¥ç«‹åˆ»åƒæ‰ï¼Œä½†ä¸é¢å¤–æ‰£åˆ†ã€‚
                    // é¡ºä¾¿å†åƒä¸€ä¸‹åŸç‚¹è±†å­ï¼ˆå› ä¸ºåˆšé‡ç”Ÿå¯èƒ½åœ¨è±†ä¸Šï¼‰
                    eatDotAtPacman(); 
                }
            }

            // ç©å®¶ç§»åŠ¨ (æ ¹æ®currentDir)
            function movePacman() {
                let moveX = 0, moveY = 0;
                switch (currentDir) {
                    case 'LEFT':  moveX = -1; break;
                    case 'RIGHT': moveX = 1; break;
                    case 'UP':    moveY = -1; break;
                    case 'DOWN':  moveY = 1; break;
                }
                let newX = pacman.x + moveX;
                let newY = pacman.y + moveY;
                if (isWalkable(newX, newY)) {
                    pacman.x = newX;
                    pacman.y = newY;
                    // ç§»åŠ¨åç«‹åˆ»åƒè±†
                    eatDotAtPacman();
                }
                // ä¸ç®¡æ˜¯å¦ç§»åŠ¨ï¼Œå°è¯•æ”¹å˜æ–¹å‘ä¸ºä¸‹ä¸€æ¬¡å‡†å¤‡ï¼ˆç¼“å­˜nextDirï¼‰
                // ä½†æ˜¯ï¼Œè¦ä¿è¯å¦‚æœnextDirå¯è¡Œï¼Œå°±è®¾ç½®currentDirä¸ºnextDirä»¥ä¾¿ä¸‹ä¸€æ¬¡ç§»åŠ¨ã€‚
            }

            // æ›´æ–°æ–¹å‘ (ç”±é”®ç›˜è§¦å‘)
            function setDirection(dir) {
                if (gameOver || gameWin) return;
                // æ£€æŸ¥æ–°æ–¹å‘æ˜¯å¦åˆæ³• (ä¸èƒ½æ˜¯å½“å‰ç›¸åæ–¹å‘? åƒè±†äººå¯ä»¥æ‰å¤´ï¼Œå…è®¸æ‰€æœ‰)
                // ä½†ä¸ºäº†æ‰‹æ„Ÿï¼Œå…è®¸æ‰€æœ‰æ–¹å‘ï¼Œç¢°æ’ç”±ç§»åŠ¨é€»è¾‘å¤„ç†
                nextDir = dir;
            }

            // åœ¨ç§»åŠ¨å‰å°è¯•åˆ‡æ¢æ–¹å‘ (æ ¹æ®nextDiræ˜¯å¦å¯è¡Œ)
            function trySwitchDirection() {
                if (!nextDir) return;
                // åˆ¤æ–­ä¸‹ä¸€æ­¥æ ¼å­æ˜¯å¦å¢™å£ï¼ˆåªåšä¸€æ¬¡é¢„æµ‹ï¼‰
                let moveX = 0, moveY = 0;
                switch (nextDir) {
                    case 'LEFT': moveX = -1; break;
                    case 'RIGHT': moveX = 1; break;
                    case 'UP': moveY = -1; break;
                    case 'DOWN': moveY = 1; break;
                }
                let newX = pacman.x + moveX;
                let newY = pacman.y + moveY;
                if (isWalkable(newX, newY)) {
                    currentDir = nextDir;
                } else {
                    // å¦‚æœnextDiræ’å¢™, åˆ™ä¿ç•™åŸæ–¹å‘(ç»§ç»­åŸæ–¹å‘ç§»åŠ¨)
                }
            }

            // æ¸¸æˆä¸»æ›´æ–° (æ¯å¸§è°ƒç”¨)
            function gameUpdate() {
                if (gameOver || gameWin) {
                    return; // åœæ­¢é€»è¾‘æ›´æ–°ï¼Œä½†ç»§ç»­æ¸²æŸ“
                }

                frameCounter++;
                // æ¯ MOVE_INTERVAL å¸§ç§»åŠ¨ä¸€æ¬¡
                if (frameCounter % MOVE_INTERVAL === 0) {
                    // 1. å°è¯•æ ¹æ®é”®ç›˜è¾“å…¥åˆ‡æ¢æ–¹å‘
                    trySwitchDirection();

                    // 2. ç§»åŠ¨pacman (åŸºäºcurrentDir)
                    movePacman();

                    // 3. å¹½çµç§»åŠ¨
                    moveGhosts();

                    // 4. ç¢°æ’æ£€æµ‹
                    if (checkGhostCollision()) {
                        handleDeath();
                    }
                }
            }

            // ---------- ç»˜åˆ¶ ----------
            function draw() {
                ctx.clearRect(0, 0, 500, 500);

                // ç»˜åˆ¶ç½‘æ ¼çº¿ (ç»†çº¿)
                ctx.strokeStyle = '#568f9b';
                ctx.lineWidth = 0.6;
                for (let i = 0; i <= COLS; i++) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#3f707c';
                    ctx.moveTo(i * CELL_SIZE, 0);
                    ctx.lineTo(i * CELL_SIZE, canvas.height);
                    ctx.stroke();
                }
                for (let i = 0; i <= ROWS; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, i * CELL_SIZE);
                    ctx.lineTo(canvas.width, i * CELL_SIZE);
                    ctx.stroke();
                }

                // ç»˜åˆ¶å¢™å£ / è±†å­
                for (let row = 0; row < ROWS; row++) {
                    for (let col = 0; col < COLS; col++) {
                        const cell = board[row][col];
                        const x = col * CELL_SIZE;
                        const y = row * CELL_SIZE;

                        if (cell === WALL) {
                            // å½©è‰²å¢™å£ï¼Œæœ‰ç«‹ä½“æ„Ÿ
                            ctx.fillStyle = '#4f7a8a';
                            ctx.fillRect(x+1, y+1, CELL_SIZE-2, CELL_SIZE-2);
                            ctx.fillStyle = '#30616e';
                            ctx.fillRect(x+3, y+3, CELL_SIZE-6, CELL_SIZE-6);
                            ctx.fillStyle = '#70a9bb';
                            ctx.fillRect(x+2, y+2, CELL_SIZE-6, CELL_SIZE-6);
                        } else if (cell === DOT) {
                            // é‡‘è‰²å°è±†è±†
                            ctx.beginPath();
                            ctx.arc(x + CELL_SIZE/2, y + CELL_SIZE/2, 6, 0, 2 * Math.PI);
                            ctx.fillStyle = '#facc6f';
                            ctx.shadowColor = '#ffd966';
                            ctx.shadowBlur = 10;
                            ctx.fill();
                            // é«˜å…‰
                            ctx.shadowBlur = 0;
                            ctx.beginPath();
                            ctx.arc(x + CELL_SIZE/2 - 2, y + CELL_SIZE/2 - 2, 2, 0, 2 * Math.PI);
                            ctx.fillStyle = '#fff7c0';
                            ctx.fill();
                        } else {
                            // ç©ºåœ° ç»˜åˆ¶ä¸€ç‚¹ç‚¹ç¼€
                            ctx.fillStyle = '#27545e';
                            ctx.fillRect(x+10, y+10, 5, 5);
                        }
                    }
                }

                // ç”»å¹½çµ (å¯çˆ±é£)
                for (let g of ghosts) {
                    const x = g.x * CELL_SIZE;
                    const y = g.y * CELL_SIZE;
                    // å¹½çµèº«ä½“
                    ctx.fillStyle = '#fc4a6c';
                    ctx.shadowColor = '#b02c45';
                    ctx.shadowBlur = 8;
                    ctx.beginPath();
                    ctx.arc(x + CELL_SIZE/2, y + CELL_SIZE/2 - 2, 12, 0, Math.PI * 2);
                    ctx.fill();
                    // ä¸‹æ‘†æ³¢æµª
                    ctx.fillRect(x+6, y+13, 14, 8);
                    // çœ¼ç›
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(x + 9, y + 9, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + 17, y + 9, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#1b262c';
                    ctx.beginPath();
                    ctx.arc(x + 8, y + 8, 2, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + 16, y + 8, 2, 0, 2*Math.PI);
                    ctx.fill();
                }

                // ç”»åƒè±†äºº
                const px = pacman.x * CELL_SIZE;
                const py = pacman.y * CELL_SIZE;
                ctx.shadowBlur = 12;
                ctx.shadowColor = '#f3b33d';
                ctx.fillStyle = '#f8e45c';
                // æ ¹æ®æ–¹å‘å¼ å˜´
                let startAngle = 0.2, endAngle = 1.8 * Math.PI;  // é»˜è®¤æœå³
                if (currentDir === 'LEFT') {
                    startAngle = 0.8 * Math.PI; endAngle = 0.2 * Math.PI;
                } else if (currentDir === 'UP') {
                    startAngle = 0.3 * Math.PI; endAngle = 0.7 * Math.PI;
                } else if (currentDir === 'DOWN') {
                    startAngle = 1.3 * Math.PI; endAngle = 1.7 * Math.PI;
                } else { // RIGHT
                    startAngle = 0.2; endAngle = 1.8 * Math.PI;
                }
                ctx.beginPath();
                ctx.moveTo(px + CELL_SIZE/2, py + CELL_SIZE/2);
                ctx.arc(px + CELL_SIZE/2, py + CELL_SIZE/2, 12, startAngle, endAngle);
                ctx.closePath();
                ctx.fill();
                // çœ¼ç›
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(px + 15, py + 8, 2.5, 0, 2*Math.PI);
                ctx.fill();

                // æ¸¸æˆç»“æŸ/èƒœåˆ© è’™å±‚
                if (gameOver) {
                    ctx.fillStyle = '#000000aa';
                    ctx.fillRect(0, 0, 500, 500);
                    ctx.font = 'bold 38px "Segoe UI", cursive';
                    ctx.fillStyle = '#fbc3b8';
                    ctx.shadowColor = '#c02233';
                    ctx.shadowBlur = 12;
                    ctx.fillText('ğŸ˜µ GAME OVER', 60, 270);
                } else if (gameWin) {
                    ctx.fillStyle = '#d4f3ffaa';
                    ctx.fillRect(0, 0, 500, 500);
                    ctx.font = 'bold 42px "Segoe UI", cursive';
                    ctx.fillStyle = '#fde156';
                    ctx.shadowColor = '#c9791e';
                    ctx.shadowBlur = 15;
                    ctx.fillText('ğŸ† ä½ èµ¢å•¦!', 90, 280);
                }

                // é‡ç½®é˜´å½±
                ctx.shadowBlur = 0;
                ctx.shadowColor = 'transparent';
            }

            function updateScoreAndLives() {
                scoreSpan.innerText = score;
                livesSpan.innerText = lives;
            }

            // åŠ¨ç”»å¾ªç¯
            function gameLoop() {
                gameUpdate();
                draw();
                updateScoreAndLives(); // æ›´æ–°è®¡åˆ†æ¿
                animationFrame = requestAnimationFrame(gameLoop);
            }

            // é”®ç›˜ç›‘å¬
            function keydownHandler(e) {
                e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
                const key = e.key;
                if (key.startsWith('Arrow')) {
                    switch (key) {
                        case 'ArrowLeft': setDirection('LEFT'); break;
                        case 'ArrowRight': setDirection('RIGHT'); break;
                        case 'ArrowUp': setDirection('UP'); break;
                        case 'ArrowDown': setDirection('DOWN'); break;
                    }
                }
            }

            // é˜»æ­¢é¡µé¢é€šè¿‡æ–¹å‘é”®æ»šåŠ¨
            window.addEventListener('keydown', function(e) {
                if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                }
            });

            // å¯åŠ¨ä¸€åˆ‡
            function init() {
                resetGame();
                if (animationFrame) cancelAnimationFrame(animationFrame);
                animationFrame = requestAnimationFrame(gameLoop);
                window.addEventListener('keydown', keydownHandler);
            }

            restartBtn.addEventListener('click', () => {
                resetGame();
                // æ— é¡»é‡ç½®ç›‘å¬
            });

            init();

            // æ¸…ç†(ç†è®ºä¸Šä¸éœ€è¦ï¼Œä½†ä¿åº•)
            window.addEventListener('beforeunload', () => {
                if (animationFrame) cancelAnimationFrame(animationFrame);
                window.removeEventListener('keydown', keydownHandler);
            });
        })();
    </script>
</body>
</html>